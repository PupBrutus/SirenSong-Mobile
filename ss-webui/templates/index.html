<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RNBO Control Server</title>
    <script>
        function sendSliderValue(sliderId) {
            const slider = document.getElementById(sliderId);
            const instanceParam = slider.dataset.instanceParam;
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.send(`${sliderId}=${slider.value}&instanceParam=${instanceParam}&action=connect`);
            
            const roundedValue = (Math.round(slider.value * 100) / 100).toFixed(2);
            document.getElementById(`${sliderId}Value`).innerText = roundedValue;
        }

        function sendDropdownValue(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const instanceParam = dropdown.dataset.instanceParam;
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.send(`${dropdownId}=${dropdown.value}&instanceParam=${instanceParam}&action=connect`);
        }

        async function fetchJSON() {
            const response = await fetch('http://127.0.0.1:5678/rnbo');
            return response.json();
        }

        function createSlider(id, label, min, max, value, instanceParam) {
            const container = document.createElement('div');
            const labelElement = document.createElement('label');
            labelElement.setAttribute('for', id);
            labelElement.innerText = label;
            const slider = document.createElement('input');
            slider.type = 'range';
            slider.id = id;
            slider.name = id;
            slider.min = min;
            slider.max = max;
            slider.value = value;
            slider.dataset.instanceParam = instanceParam;
            slider.oninput = () => sendSliderValue(id);
            const valueSpan = document.createElement('span');
            valueSpan.id = `${id}Value`;
            valueSpan.innerText = value;
            container.appendChild(labelElement);
            container.appendChild(slider);
            container.appendChild(valueSpan);
            return container;
        }

        function createDropdown(id, label, options, value, instanceParam) {
            const container = document.createElement('div');
            const labelElement = document.createElement('label');
            labelElement.setAttribute('for', id);
            labelElement.innerText = label;
            const dropdown = document.createElement('select');
            dropdown.id = id;
            dropdown.name = id;
            dropdown.dataset.instanceParam = instanceParam;
            dropdown.onchange = () => sendDropdownValue(id);
            options.forEach(optionValue => {
                const option = document.createElement('option');
                option.value = optionValue;
                option.text = optionValue;
                if (optionValue === value) {
                    option.selected = true;
                }
                dropdown.appendChild(option);
            });
            const valueSpan = document.createElement('span');
            valueSpan.id = `${id}Value`;
            valueSpan.innerText = value;
            container.appendChild(labelElement);
            container.appendChild(dropdown);
            container.appendChild(valueSpan);
            return container;
        }

        async function generateControls() {
            const json = await fetchJSON();
            const parameterControls = document.getElementById('parameterControls');
            parameterControls.innerHTML = ''; // Clear existing controls

            Object.keys(json.CONTENTS.inst.CONTENTS).forEach(instanceId => {
                const instance = json.CONTENTS.inst.CONTENTS[instanceId];
                const instanceDiv = document.createElement('div');
                const instanceTitle = document.createElement('h2');
                instanceTitle.innerText = `${instance.name.VALUE} Controls`;
                instanceDiv.appendChild(instanceTitle);

                Object.keys(instance.params.CONTENTS).forEach(paramId => {
                    const param = instance.params.CONTENTS[paramId];
                    if (param.TYPE === 'f') {
                        const slider = createSlider(
                            `${instanceId}_${paramId}`,
                            paramId,
                            param.RANGE[0].MIN,
                            param.RANGE[0].MAX,
                            param.VALUE,
                            param.FULL_PATH
                        );
                        instanceDiv.appendChild(slider);
                    } else if (param.TYPE === 's' && param.RANGE) {
                        const dropdown = createDropdown(
                            `${instanceId}_${paramId}`,
                            paramId,
                            param.RANGE[0].VALS,
                            param.VALUE,
                            param.FULL_PATH
                        );
                        instanceDiv.appendChild(dropdown);
                    }
                });

                parameterControls.appendChild(instanceDiv);
            });
        }

        window.onload = function() {
            generateControls();
        };
    </script>
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: Arial, sans-serif;
        }
        h1, h2 {
            color: #bb86fc;
        }
        label {
            color: #e0e0e0;
        }
        input[type="text"], select {
            background-color: #333;
            color: #e0e0e0;
            border: 1px solid #444;
        }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            background: #444;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            background: #bb86fc;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 15px;
            height: 15px;
            background: #bb86fc;
            cursor: pointer;
        }
        button {
            background-color: #333;
            color: #e0e0e0;
            border: 1px solid #444;
            padding: 10px;
            cursor: pointer;
        }
        button.active {
            background-color: green;
        }
        button:hover {
            background-color: #444;
        }
        select {
            background-color: #333;
            color: #e0e0e0;
            border: 1px solid #444;
        }
        span {
            color: #bb86fc;
        }
    </style>
</head>
<body>
    <h1>RNBO Control</h1>
    <form method="POST">
        <label for="server">Server:</label>
        <input type="text" id="server" name="server" value="{{ server }}"><br><br>
        <label for="port">Port:</label>
        <input type="text" id="port" name="port" value="{{ port }}"><br><br>
        <!-- <button type="button" onclick="sendLoadParameter()">Load SirenSong</button><br><br> -->
        
        <div id="parameterControls"></div>
    </form>
</body>
</html>